generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//--------------------//-------Dojo---------//--------------------//

model Dojos {
  id              Int               @id @default(autoincrement())
  dojo            String
  phone           String            @default("")
  description     String            @default("")
  address         String
  logo            String            @default("")
  latitude        Float // Guardará algo como 10.6447
  longitude       Float // Guardará algo como -71.6104
  code            String
  Activities      Activities[]
  DojoAttendance  DojoAttendance[]
  PaymentMethods  PaymentMethods[]
  Schedules       Schedules[]
  Users           Users[]
  activityDojos   ActivityDojos[]
  dojoMartialArts DojoMartialArts[]
  dojoImages      DojoImages[]
}

model DojoImages {
  id     Int    @id @default(autoincrement())
  dojoId Int
  url    String
  dojo   Dojos  @relation(fields: [dojoId], references: [id])
}

model DojoMartialArts {
  id           Int         @id @default(autoincrement())
  dojoId       Int
  martialArtId Int
  dojo         Dojos       @relation(fields: [dojoId], references: [id])
  martialArt   MartialArts @relation(fields: [martialArtId], references: [id])

  @@unique([dojoId, martialArtId]) // Evita duplicados
}

model DojoAttendance {
  id             Int      @id @default(autoincrement())
  userId         Int
  dojoId         Int
  scheduleId     Int
  attendanceDate DateTime @default(now())

  // Relaciones
  user     Users     @relation(fields: [userId], references: [id])
  dojo     Dojos     @relation(fields: [dojoId], references: [id])
  schedule Schedules @relation(fields: [scheduleId], references: [id])

  // --- ÍNDICES OPTIMIZADOS ---

  // 1. Optimiza: Ver el historial de UN alumno (del más reciente al más antiguo)
  @@index([userId, attendanceDate(sort: Desc)])
  // 2. Optimiza: Ver la asistencia de UNA clase específica en una fecha
  @@index([scheduleId, attendanceDate])
  // 3. Optimiza: Reportes globales de TODO el dojo por rango de fechas
  // Al poner la fecha primero, este índice reemplaza al que borramos.
  @@index([dojoId, attendanceDate])
}

model Schedules {
  id              Int              @id @default(autoincrement())
  dojoId          Int
  name            String
  description     String           @default("")
  day             String
  startTime       String
  endTime         String
  martialArtId    Int
  dojo            Dojos            @relation(fields: [dojoId], references: [id])
  martialArts     MartialArts      @relation(fields: [martialArtId], references: [id])
  dojoAttendances DojoAttendance[]
}

//--------------------//------General-------//--------------------//

model MartialArts {
  id              Int               @id @default(autoincrement())
  martialArt      String
  icon            String
  AppliedStudents AppliedStudents[]
  Exams           Exams[]
  Ranks           Ranks[]
  Schedules       Schedules[]
  userRanks       UserRanks[]
  dojoMartialArts DojoMartialArts[]
}

model Ranks {
  id              Int               @id @default(autoincrement())
  code            String
  rank_name       String
  belt            String
  icon            String
  martialArtId    Int
  AppliedStudents AppliedStudents[]
  Exams           Exams[]
  martialArt      MartialArts       @relation(fields: [martialArtId], references: [id])
  userRanks       UserRanks[]
}

//--------------------//------Users/Students--------//--------------------//

model Users {
  id                 Int                  @id @default(autoincrement())
  identification     String
  name               String
  lastName           String
  password           String
  email              String
  username           String
  address            String
  phone              String
  sex                String               @default("Masculino")
  dojoId             Int
  rolId              Int
  birthday           DateTime
  profileImg         String
  active             Boolean
  deleted            Boolean
  createdAt          DateTime             @default(now())
  enrollmentDate     DateTime
  activityAttendance ActivityAttendance[]
  AppliedStudents    AppliedStudents[]
  DojoAttendance     DojoAttendance[]
  Exams              Exams[]
  Payments           Payments[]
  representedUsers   Representatives[]    @relation("Representative")
  student            Representatives[]    @relation("Students")
  dojo               Dojos                @relation(fields: [dojoId], references: [id])
  rol                Roles                @relation(fields: [rolId], references: [id])
  userRanks          UserRanks[]
}

model UserRanks {
  id            Int         @id @default(autoincrement())
  userId        Int
  martialArtId  Int
  currentRankId Int // Apunta al último rango obtenido en esa arte
  updatedAt     DateTime    @updatedAt
  user          Users       @relation(fields: [userId], references: [id])
  martialArt    MartialArts @relation(fields: [martialArtId], references: [id])
  rank          Ranks       @relation(fields: [currentRankId], references: [id])

  @@unique([userId, martialArtId]) // Un usuario solo tiene un registro por arte marcial
}

model Representatives {
  id               Int   @id @default(autoincrement())
  representativeId Int
  studentId        Int
  representative   Users @relation("Representative", fields: [representativeId], references: [id])
  student          Users @relation("Students", fields: [studentId], references: [id])
}

model Roles {
  id    Int     @id @default(autoincrement())
  rol   String
  Users Users[]
}

//--------------------//-------Activities-------//--------------------//

model Activities {
  id          Int      @id @default(autoincrement())
  name        String
  date        DateTime
  place       String
  price       Float    @default(0)
  latitude    Float
  longitude   Float
  createdDate DateTime @default(now())

  // Relación con la tabla intermedia
  ActivityDojos ActivityDojos[]

  // Otras relaciones que ya tenías
  activityAttendance ActivityAttendance[]
  AppliedStudents    AppliedStudents[]
  Exams              Exams[]
  dojos              Dojos?               @relation(fields: [dojosId], references: [id])
  dojosId            Int?
  activitiesImages   ActivitiesImages[]
}

model ActivitiesImages {
  id         Int        @id @default(autoincrement())
  activityId Int
  url        String
  activity   Activities @relation(fields: [activityId], references: [id])
}

model ActivityDojos {
  id         Int @id @default(autoincrement())
  activityId Int
  dojoId     Int

  // Relaciones
  activity Activities @relation(fields: [activityId], references: [id])
  dojo     Dojos      @relation(fields: [dojoId], references: [id])

  // Evita que un dojo se asigne dos veces a la misma actividad
  @@unique([activityId, dojoId])
}

model ActivityAttendance {
  id         Int        @id @default(autoincrement())
  activityId Int
  userId     Int
  activity   Activities @relation(fields: [activityId], references: [id])
  user       Users      @relation(fields: [userId], references: [id])
}

model Exams {
  id           Int         @id @default(autoincrement())
  martialArtId Int
  userId       Int
  ranksId      Int
  activityId   Int
  activity     Activities  @relation(fields: [activityId], references: [id])
  martialArt   MartialArts @relation(fields: [martialArtId], references: [id])
  ranks        Ranks       @relation(fields: [ranksId], references: [id])
  user         Users       @relation(fields: [userId], references: [id])
}

model AppliedStudents {
  id           Int         @id @default(autoincrement())
  martialArtId Int
  userId       Int
  ranksId      Int
  activityId   Int
  activity     Activities  @relation(fields: [activityId], references: [id])
  martialArt   MartialArts @relation(fields: [martialArtId], references: [id])
  ranks        Ranks       @relation(fields: [ranksId], references: [id])
  user         Users       @relation(fields: [userId], references: [id])
}

//--------------------//------Payments-------//--------------------//

model PaymentMethods {
  id             Int        @id @default(autoincrement())
  payment_method String
  bank           String
  phone          String
  email          String
  identification String
  dojoId         Int
  dojo           Dojos      @relation(fields: [dojoId], references: [id])
  Payments       Payments[]
}

model Payments {
  id              Int            @id @default(autoincrement())
  userId          Int
  paymentMethodId Int
  amount          Int
  payment_date    DateTime
  paymentMethod   PaymentMethods @relation(fields: [paymentMethodId], references: [id])
  user            Users          @relation(fields: [userId], references: [id])
}
